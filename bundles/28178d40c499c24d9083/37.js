(window.webpackJsonp=window.webpackJsonp||[]).push([[37],{1540:function(e,t,n){"use strict";n.r(t),n.d(t,"sendMessage",(function(){return R})),n.d(t,"editMessage",(function(){return F}));var r=n(27),a=n.n(r),o=n(33),i=n(107),c=n(5),s=n(357),l=n(216),d=n(423),m=n(641),u=n(8),b=n(351),p=n(1415),g=n(1),f=n.n(g),y=n(1437),v=n(13),O=n(47),j=n(161),h=n(271);function C(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function E(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?C(Object(n),!0).forEach((function(t){f()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):C(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const k="/me ";const w=e=>e instanceof v.MatrixEvent;async function _(e,t,n){let{relation:r,replyToEvent:a,permalinkCreator:o,includeReplyLegacyFallback:i=!0,editedEvent:s}=n;const l=w(s),d=l?Boolean(s.replyEventId):w(a),m=l&&d,u=e.startsWith(k);u&&(e=e.slice(k.length)),e.startsWith("//")&&(e=e.slice(1));const b=t?await Object(y.richToPlain)(e):function(e){const t=(new DOMParser).parseFromString(e,"text/html");return Array.from(t.querySelectorAll("a[data-mention-type]")).forEach((e=>{switch(e.getAttribute("data-mention-type")){case"at-room":e.replaceWith("@room");break;case"user":{const t=e.innerHTML;e.replaceWith(t);break}case"room":{const t=e.getAttribute("href");if(null===t)break;const n=Object(O.h)(t);Object(h.a)(n)&&Object(h.a)(n.roomIdOrAlias)&&e.replaceWith(n.roomIdOrAlias);break}}})),t.body.innerHTML}(e),p=m&&function(e){const t=e.getContent().body;if("string"!=typeof t)return"";const n=t.split("\n").map((e=>e.trim()));return n.length>2&&n[0].startsWith("> ")&&0===n[1].length?`${n[0]}\n\n`:""}(s)||"",g=m&&function(e){const t=e.getContent().formatted_body;if(!t)return"";const n=(new DOMParser).parseFromString(t,"text/html").body.querySelector("mx-reply");return n&&n.outerHTML||""}(s)||"",f={msgtype:u?v.MsgType.Emote:v.MsgType.Text,body:l?`${p} * ${b}`:b},C=c.b.getValue("MessageComposerInput.useMarkdown"),_=t?e:C?await Object(y.plainToRich)(e):null;_&&(f.format="org.matrix.custom.html",f.formatted_body=l?`${g} * ${_}`:_),l&&(f["m.new_content"]={msgtype:f.msgtype,body:b},_&&(f["m.new_content"].format="org.matrix.custom.html",f["m.new_content"].formatted_body=_));return function(e,t){t&&(e["m.relates_to"]=E(E({},e["m.relates_to"]||{}),t))}(f,l?E(E({},r),{},{rel_type:"m.replace",event_id:s.getId()}):r),!l&&a&&o&&Object(j.a)(f,a,{permalinkCreator:o,includeLegacyFallback:i}),f}var T=n(126),x=n(246),S=n(14),M=n(348);const P=["roomContext","mxClient"];async function R(e,t,n){var r;let{roomContext:b,mxClient:p}=n,g=a()(n,P);const{relation:f,replyToEvent:y,permalinkCreator:v}=g,{room:O}=b,h=null==O?void 0:O.roomId;if(!h)return;const C={eventName:"Composer",isEditing:!1,isReply:Boolean(y),inThread:(null==f?void 0:f.rel_type)===o.d.name};i.a.instance.trackEvent(C);let E=null;if(e.startsWith("/")&&!e.startsWith("//")&&!e.startsWith(k)){const{cmd:t,args:n}=Object(T.d)(e);if(t){const e=(null==f?void 0:f.rel_type)===o.d.name?null==f?void 0:f.event_id:null;let r;if([E,r]=await Object(x.c)(p,t,n,h,null!=e?e:null),!r)return;if(!E||t.category!==T.a.messages&&t.category!==T.a.effects)return;var w,R;Object(M.b)(E,f),y&&Object(j.a)(E,y,{permalinkCreator:v,includeLegacyFallback:null===(w=null===(R=E.msgtype)||void 0===R?void 0:R.startsWith("m."))||void 0===w||w})}else{const t=await Object(x.d)(e);if(u.a.dispatch({action:S.a.FocusAComposer,context:b.timelineRenderingType}),!t)return}}if(null!==(r=E)&&void 0!==r||(E=await _(e,t,g)),!E.body.trim())return;c.b.getValue("Performance.addSendMessageTimingMetadata")&&Object(s.a)(E);const F=null!=f&&f.event_id&&(null==f?void 0:f.rel_type)===o.d.name?f.event_id:null,W=Object(l.a)(h,(e=>p.sendMessage(e,F,E)),p);return y&&u.a.dispatch({action:"reply_to_event",event:null,context:b.timelineRenderingType}),u.a.dispatch({action:"message_sent"}),d.CHAT_EFFECTS.forEach((e=>{if(E&&Object(m.containsEmoji)(E,e.emojis)){(null==f?void 0:f.rel_type)!==o.d.name&&u.a.dispatch({action:`effects.${e.command}`})}})),c.b.getValue("Performance.addSendMessageTimingMetadata")&&W.then((e=>{Object(s.b)(p,h,e.event_id)})),c.b.getValue("scrollToBottomOnMessageSent")&&u.a.dispatch({action:"scroll_to_bottom",timelineRenderingType:b.timelineRenderingType}),W}async function F(e,t){let{roomContext:n,mxClient:r,editorStateTransfer:a}=t;const o=a.getEvent();i.a.instance.trackEvent({eventName:"Composer",isEditing:!0,inThread:Boolean(null==o?void 0:o.getThread()),isReply:Boolean(o.replyEventId)});const c=await _(e,!0,{editedEvent:o}),s=c["m.new_content"];if(""===(null==s?void 0:s.body))return Object(p.a)(r,a),void Object(b.a)({mxEvent:o,onCloseDialog:()=>{Object(p.b)(n)}});let l;const d=o.getRoomId();if(function(e,t){const n=t.getEvent().getContent();return n.msgtype!==e.msgtype||n.body!==e.body||n.format!==e.format||n.formatted_body!==e.formatted_body}(s,a)&&d){Object(p.a)(r,a);const e=a.getEvent().threadRootId||null;l=r.sendMessage(d,e,c),u.a.dispatch({action:"message_sent"})}return Object(p.b)(n),l}},1697:function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return R}));var r=n(18),a=n.n(r),o=n(27),i=n.n(o),c=n(0),s=n.n(c),l=n(12),d=n.n(l),m=n(1537),u=n(2),b=n(9);function p(e){let{onCancelClick:t,onSaveClick:n,isSaveDisabled:r=!1}=e;return s.a.createElement("div",{className:"mx_EditWysiwygComposer_buttons"},s.a.createElement(b.a,{kind:"secondary",onClick:t},Object(u.b)("Cancel")),s.a.createElement(b.a,{kind:"primary",onClick:n,disabled:r},Object(u.b)("Save")))}var g=n(8),f=n(14),y=n(31),v=n(639),O=n(1413),j=n(431),h=n(1414),C=n(1402);var E=n(26),k=n(1415),w=n(1540);var _=n(324),T=n(48),x=n(5);function S(e){const t=Object(y.c)(),n=Object(E.b)();return Object(c.useMemo)((()=>{if(e&&t.room&&n)return function(e,t,n){const r=new T.a(t,n);let a=[];if(e.hasEditorState()){const t=e.getSerializedParts();null!==t&&(a=t.map((e=>r.deserializePart(e))))}else{if("org.matrix.custom.html"===e.getEvent().getContent().format)return function(e){var t;return(null===(t=e.getEvent().getContent().formatted_body)||void 0===t?void 0:t.replace(/<mx-reply>.*<\/mx-reply>/,""))||""}(e);a=Object(_.b)(e.getEvent(),r,{shouldEscape:x.b.getValue("MessageComposerInput.useMarkdown")})}return a.reduce(((e,t)=>e+(null==t?void 0:t.text)),"")}(e,t.room,n)}),[e,t,n])}const M=["editorStateTransfer","className"],P=Object(c.forwardRef)((function(e,t){let{disabled:n=!1,composerFunctions:r}=e;return function(e,t,n){const r=Object(y.c)(),a=Object(C.c)(),o=Object(c.useRef)(null),i=Object(c.useCallback)((i=>{var c;if(e||!t.current)return;const s=null!==(c=i.context)&&void 0!==c?c:y.a.Room;switch(i.action){case f.a.FocusEditMessageComposer:Object(O.a)(t,s,r,o);break;case f.a.ComposerInsert:if(i.timelineRenderingType!==r.timelineRenderingType)break;if(i.composerType!==j.a.Edit)break;i.text&&Object(h.d)(a.selection).then((()=>n.insertText(i.text)))}}),[e,t,n,o,r,a]);Object(v.a)(g.a,i)}(n,t,r),null}));function R(e){let{editorStateTransfer:t,className:n}=e,r=i()(e,M);const o=Object(c.useRef)(Object(C.b)({editorStateTransfer:t})),l=S(t),u=!t||void 0!==l,{editMessage:b,endEditing:g,onChange:f,isSaveDisabled:v}=function(e,t){const n=Object(y.c)(),r=Object(E.b)(),[a,o]=Object(c.useState)(!0),[i,s]=Object(c.useState)(t);return{onChange:Object(c.useCallback)((e=>{s(e),o((n=>n&&e===t))}),[t]),editMessage:Object(c.useCallback)((async()=>{if(void 0!==r&&void 0!==i)return Object(w.editMessage)(i,{roomContext:n,mxClient:r,editorStateTransfer:e})}),[i,n,r,e]),endEditing:Object(c.useCallback)((()=>Object(k.b)(n)),[n]),isSaveDisabled:a}}(t,l);return u?s.a.createElement(C.a.Provider,{value:o.current},s.a.createElement(m.a,a()({className:d()("mx_EditWysiwygComposer",n),initialContent:l,onChange:f,onSend:b},r),((e,t)=>s.a.createElement(s.a.Fragment,null,s.a.createElement(P,{disabled:r.disabled,ref:e,composerFunctions:t}),s.a.createElement(p,{onCancelClick:g,onSaveClick:b,isSaveDisabled:v}))))):s.a.createElement(s.a.Fragment,null)}}}]);
//# sourceMappingURL=37.js.map